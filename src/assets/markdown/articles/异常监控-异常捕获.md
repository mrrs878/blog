---
title: 异常监控-异常捕获
date: 2020-7-28 11:15:28
tags: 异常监控
categories: 前端架构&软实力
---

## 异常分类

- 编译时异常/运行时异常

着重处理运行时异常

## 要处理的异常

- js运行时异常
- 静态资源加载异常
- Promise异常
- ajax请求异常
- 崩溃和卡顿

## 捕获异常

### 普通前端项目

```js
// monitor.js

// js运行时异常
function syncAndAsyncError() {
  window.onerror = function (msg, url, lineNo, columnNo, error) {
    console.log('syncAndAsyncError', msg, url, lineNo, columnNo, error)
    return true
  }
}

// Promise异常
function promiseError() {
  window.addEventListener("unhandledrejection", function(e){
    e.preventDefault()
    console.log('promiseError', e);
    return true;
  }, true);
}

// 静态资源加载异常
function assetsError() {
  window.addEventListener('error', function (e) {
    const { target } = e
    const isElementTarget = target instanceof HTMLScriptElement || target instanceof HTMLLinkElement || target instanceof HTMLImageElement;
    if (!isElementTarget) return false
    console.log('assetsError', e);
    return true
  }, true)
}

// ajax请求异常
function ajaxError() {
  const protocol = window.location.protocol
  if (protocol === 'file:') return
  if (!window.XMLHttpRequest) return
  const xmlReq = window.XMLHttpRequest
  const oldSend = xmlReq.prototype.send
  const oldOpen = xmlReq.prototype.open
  function handleEvent(event) {
    try {
      if (event && event.currentTarget && event.currentTarget.status !== 200) {
        console.log('ajaxError', event.currentTarget);
      }
    } catch (e) {
      console.log('Tool\'s error: ' + e);
    }
  }
  xmlReq.prototype.send = function() {
    this.addEventListener('error', handleEvent)
    this.addEventListener('load', handleEvent)
    this.addEventListener('abort', handleEvent)
    return oldSend.apply(this, arguments)
  }
  xmlReq.prototype.open = function(method, url) {
    oldOpen.apply(this, arguments)
    this.ajaxUrl = url
  }
}

function init() {
  syncAndAsyncError()
  promiseError()
  assetsError()
  ajaxError()
}

init()
```

### 基于Vue.js的项目

针对于Vue.js项目，虽然官方提供有`Vue.config.errorHandler`来拦截内部错误(生命周期、事件绑定等)。但处理能力有限，无法处理js运行时异步异常(如setTimeout)和资源加载异常等，因此需要使用`mointor.js` + `Vue.config.errorHandler`来共同处理

### 基于React.js的项目

// todo

## 异常和卡顿

// todo
